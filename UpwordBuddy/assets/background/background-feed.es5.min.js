"use strict";

function CreateAlarm() {
    chrome.alarms.create("jobsFetch", {
        periodInMinutes: 1
    })
}

function ClearAlarm() {
    chrome.alarms.clear("jobsFetch")
}

function FatchUnReadJob(n) {
    return result.length == 0 ? n : jQuery.grep(n, function(n) {
        return n.publishedOn > result[0].publishedOn
    })
}

function ShowNotification(n, t) {
    if (t.Watcher == !1 || (badgeCount = badgeCount + n, n > 9 && (n = "9+"), chrome.notifications.create("freshJobs", {
            type: "basic",
            iconUrl: "./icons/app/mailtangy-48.png",
            title: "You got " + n + " new jobs!",
            message: "Don't miss your chance",
            buttons: [{
                title: "Click here to take a look new jobs"
            }, {
                title: "Close"
            }]
        }), chrome.browserAction.setBadgeText({
            text: badgeCount.toString()
        }), chrome.browserAction.setBadgeBackgroundColor({
            color: "#f44e42"
        }), t.Sound == !1)) return !0;
    var i = new Audio("/multimedia/NotiSound.mp3");
    i.play()
}

function FatchFeed(n) {
    n && chrome.storage.local.get("feedResult", function(n) {
        n && n.hasOwnProperty("feedResult") && (result = n.feedResult)
    });
    $.ajax({
        async: !0,
        crossDomain: !0,
        url: "https://www.upwork.com/ab/find-work/api/feeds/search",
        method: "GET",
        headers: {
            "x-requested-with": "XMLHttpRequest"
        }
    }).done(function(n) {
        chrome.storage.sync.set({
            isLogin: !0
        });
        var t = FatchUnReadJob(n.results);
        t.length > 0 && chrome.storage.sync.get("setting", function(n) {
            n && n.hasOwnProperty("setting") && ShowNotification(t.length, n.setting)
        });
        setTimeout(function() {
            result = n.results;
            chrome.storage.local.set({
                feedResult: result
            })
        }, 1e3)
    }).fail(function() {
        chrome.storage.sync.set({
            isLogin: !1
        });
        chrome.browserAction.setBadgeText({
            text: "Error"
        });
        chrome.browserAction.setBadgeBackgroundColor({
            color: "#f44e42"
        })
    })
}
var badgeCount = 0,
    result;
chrome.notifications.onButtonClicked.addListener(function(n, t) {
    t == 0 ? (chrome.tabs.create({
        url: "/feed.html"
    }), chrome.notifications.clear(n)) : chrome.notifications.clear(n)
});
chrome.alarms.onAlarm.addListener(function(n) {
    n.name === "jobsFetch" && FatchFeed(!1)
});
result = [];
FatchFeed(!0);
CreateAlarm();